# cert-manager DNS-01 via Cloudflare (bypasses HTTP routing - use when HTTP-01 fails on GKE Gateway)
# Requires: pinogy.com in Cloudflare, API token with Zone Read + DNS Edit
#
# Setup (run once):
#   1. Create token at Cloudflare: My Profile > API Tokens > Create Token
#      - Permissions: Zone - Zone - Read, Zone - DNS - Edit
#      - Zone Resources: Include - All Zones
#   2. kubectl create secret generic cloudflare-api-token -n cert-manager \
#        --from-literal=api-token=YOUR_CLOUDFLARE_API_TOKEN
#   3. kubectl apply -f k8s/sign/cert-manager-dns01.yaml -n sign

---
apiVersion: cert-manager.io/v1
kind: ClusterIssuer
metadata:
  name: letsencrypt-prod-dns01
spec:
  acme:
    server: https://acme-v02.api.letsencrypt.org/directory
    email: mark.meadows@pinogy.com
    privateKeySecretRef:
      name: letsencrypt-prod-dns01-account-key
    solvers:
      - dns01:
          cloudflare:
            apiTokenSecretRef:
              name: cloudflare-api-token
              key: api-token
---
apiVersion: cert-manager.io/v1
kind: Certificate
metadata:
  name: sign-tls
  namespace: sign
spec:
  secretName: sign-tls
  issuerRef:
    name: letsencrypt-prod-dns01
    kind: ClusterIssuer
  dnsNames:
    - sign.pinogy.com
    - sign-token.pinogy.com
