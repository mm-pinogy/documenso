# GKE Gateway for sign namespace - uses static IP pinogy-apps
# Apply: kubectl apply -f k8s/sign/gateway.yaml -n sign
#
# Prerequisites:
# - Create static IP: ./k8s/sign/static-ip.sh  (or gcloud compute addresses create pinogy-apps --global)
# - Gateway API enabled on cluster: gcloud container clusters update CLUSTER --gateway-api=standard
# - cert-manager installed: ./k8s/sign/cert-manager-install.sh
# - Certificate issued: kubectl apply -f k8s/sign/cert-manager.yaml -n sign
#
# Routes sign.pinogy.com and sign-token.pinogy.com to documenso-app and token-exchange.
# HTTP (80) for ACME challenges; HTTPS (443) with Let's Encrypt cert.

apiVersion: gateway.networking.k8s.io/v1
kind: Gateway
metadata:
  name: sign-gateway
  namespace: sign
spec:
  gatewayClassName: gke-l7-global-external-managed
  addresses:
    - type: NamedAddress
      value: pinogy-apps
  listeners:
    - name: http
      protocol: HTTP
      port: 80
      allowedRoutes:
        namespaces:
          from: All
    - name: https
      protocol: HTTPS
      port: 443
      tls:
        mode: Terminate
        certificateRefs:
          - kind: Secret
            group: ""
            name: sign-tls
      allowedRoutes:
        namespaces:
          from: All
---
# HTTPRoute: sign.pinogy.com -> documenso-app
apiVersion: gateway.networking.k8s.io/v1
kind: HTTPRoute
metadata:
  name: sign-app-route
  namespace: sign
spec:
  parentRefs:
    - name: sign-gateway
      namespace: sign
      sectionName: https
  hostnames:
    - sign.pinogy.com
  rules:
    - matches:
        - path:
            type: PathPrefix
            value: /
      backendRefs:
        - name: documenso-app
          port: 80
---
# HTTPRoute: sign-token.pinogy.com -> token-exchange
apiVersion: gateway.networking.k8s.io/v1
kind: HTTPRoute
metadata:
  name: sign-token-route
  namespace: sign
spec:
  parentRefs:
    - name: sign-gateway
      namespace: sign
      sectionName: https
  hostnames:
    - sign-token.pinogy.com
  rules:
    - matches:
        - path:
            type: PathPrefix
            value: /
      backendRefs:
        - name: token-exchange
          port: 80
---
# Health check for documenso-app (uses /api/health, port 3000)
apiVersion: networking.gke.io/v1
kind: HealthCheckPolicy
metadata:
  name: documenso-app-healthcheck
  namespace: sign
spec:
  default:
    config:
      type: HTTP
      httpHealthCheck:
        portSpecification: USE_FIXED_PORT
        port: 3000
        requestPath: /api/health
  targetRef:
    group: ""
    kind: Service
    name: documenso-app
---
# Health check for token-exchange (uses /api/health, port 3000)
apiVersion: networking.gke.io/v1
kind: HealthCheckPolicy
metadata:
  name: token-exchange-healthcheck
  namespace: sign
spec:
  default:
    config:
      type: HTTP
      httpHealthCheck:
        portSpecification: USE_FIXED_PORT
        port: 3000
        requestPath: /api/health
  targetRef:
    group: ""
    kind: Service
    name: token-exchange
